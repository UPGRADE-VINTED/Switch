<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Commande Switch personnalisée</title>
<style>
  body {
    font-family: Arial, sans-serif;
    padding: 1rem;
    background: #f9f9f9;
    max-width: 600px;
    margin: auto;
  }
  h2 {
    margin-bottom: 0.5rem;
  }
  .container {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    justify-content: center;
  }
  .option {
    border: 2px solid #ccc;
    border-radius: 6px;
    padding: 10px;
    width: 140px;
    text-align: center;
    cursor: pointer;
    background: white;
    transition: border-color 0.3s ease;
    position: relative;
  }
  .option.selected {
    border-color: #007bff;
  }
  .option img {
    max-width: 100%;
    height: auto;
    border-radius: 4px;
    user-select: none;
    transition: transform 0.3s ease;
  }
  .option img.zoomed {
    transform: scale(1.6);
    z-index: 10;
    position: relative;
  }
  .option div {
    margin-top: 8px;
    font-weight: bold;
  }

  /* Pour le choix Joycon + et - */
  .qty-control {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    margin-top: 6px;
  }
  .qty-control button {
    width: 28px;
    height: 28px;
    border: none;
    border-radius: 4px;
    background: #007bff;
    color: white;
    font-weight: bold;
    font-size: 18px;
    cursor: pointer;
  }
  .qty-control button:disabled {
    background: #ccc;
    cursor: not-allowed;
  }
  .qty-display {
    min-width: 25px;
    text-align: center;
  }

  /* Résumé ticket style */
  #resumeCommande {
    background: white;
    border: 2px solid #007bff;
    border-radius: 8px;
    padding: 1rem;
    margin-top: 20px;
    font-family: "Courier New", Courier, monospace;
    white-space: pre-line;
    box-shadow: 0 0 10px #007bff44;
  }

  /* Bouton valider */
  #btnValider {
    margin-top: 15px;
    background-color: #28a745;
    color: white;
    border: none;
    font-size: 1rem;
    padding: 10px 15px;
    border-radius: 6px;
    cursor: pointer;
    width: 100%;
  }
  #btnValider:hover {
    background-color: #218838;
  }

  /* Checkbox validée verte devant HWFLY */
  .hwfly-label {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 10px;
  }
  .hwfly-label input[type="checkbox"] {
    appearance: none;
    -webkit-appearance: none;
    width: 22px;
    height: 22px;
    border: 2px solid #28a745;
    border-radius: 4px;
    background-color: #28a745;
    cursor: default;
    position: relative;
  }
  .hwfly-label input[type="checkbox"]::after {
    content: "✔";
    color: white;
    font-weight: bold;
    position: absolute;
    left: 4px;
    top: 0px;
    font-size: 16px;
  }

  /* Hide the grey checkbox */
  .hwfly-label input[type="checkbox"].inactive {
    display: none;
  }

  /* Responsive */
  @media (max-width: 480px) {
    .option {
      width: 120px;
    }
    .option img.zoomed {
      transform: scale(1.3);
    }
  }
</style>
</head>
<body>

<h2>1. Choix de la Switch</h2>
<div id="switchContainer" class="container"></div>

<h2>2. Choix de la Carte SD</h2>
<div id="sdContainer" class="container"></div>

<h2>3. Choix des Joycon</h2>
<div id="joyconContainer" class="container"></div>

<h2>4. Accessoires</h2>
<div id="accessoireContainer" class="container"></div>

<label class="hwfly-label">
  <input type="checkbox" checked disabled />
  HWFLY (choix par défaut, validé)
  <input type="checkbox" class="inactive" />
</label>

<button id="btnValider">Valider ma liste</button>

<pre id="resumeCommande">Prévisualisation du résumé...</pre>

<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script>
  // Données
  const switches = [
    {id: 'switch_v2_sd', name: 'Switch V2 (manque SD) + puce', price: 190, stock: 5, img: 'https://i.imgur.com/XNzqOsB.jpeg'},
    {id: 'switch_v2_ok', name: 'Switch V2 OK', price: 230, stock: 3, img: 'https://i.imgur.com/zKeTFqq.png'},
    {id: 'switch_v1_rayure', name: 'Switch V1 rayure', price: 140, stock: 2, img: 'https://i.imgur.com/p5yO1kM.png'},
    {id: 'switch_v1_ok', name: 'Switch V1 OK', price: 150, stock: 4, img: 'https://i.imgur.com/p5yO1kM.png'},
    {id: 'switch_v1_excellent', name: 'Switch V1 excellent', price: 160, stock: 2, img: 'https://i.imgur.com/p5yO1kM.png'},
  ];
  const sds = [
    {id: 'sd128', name: 'Carte SD 128 Go (environ 10 jeux)', price: 0, stock: 20, img: 'https://i.imgur.com/ZRiCDLr.jpeg'},
    {id: 'sd256', name: 'Carte SD 256 Go (environ 18 jeux)', price: 20, stock: 15, img: 'https://i.imgur.com/ZRiCDLr.jpeg'},
    {id: 'sd512', name: 'Carte SD 512 Go (environ 40 jeux)', price: 50, stock: 10, img: 'https://i.imgur.com/a3M2P8z.png'}
  ];
  const joycons = [
    {id: 'joycon_rouge_bleu', name: 'Joy-Con Rouge/Bleu', priceFirst: 35, priceNext: 30, stock: 20, img: 'https://i.imgur.com/h4i6NT2.jpeg'},
    {id: 'joycon_vert_rose', name: 'Joy-Con Vert/Rose', priceFirst: 35, priceNext: 30, stock: 10, img: 'https://i.imgur.com/HnrlZdX.png'},
    {id: 'joycon_gris', name: 'Joy-Con Gris', priceFirst: 35, priceNext: 30, stock: 15, img: 'https://i.imgur.com/HnrlZdX.png'},
    {id: 'joycon_jaune', name: 'Joy-Con Jaune', priceFirst: 35, priceNext: 30, stock: 8, img: 'https://i.imgur.com/1lwBpOt.jpeg'},
    {id: 'joycon_violet', name: 'Joy-Con Violet', priceFirst: 35, priceNext: 30, stock: 5, img: 'https://i.imgur.com/edqgNwl.jpeg'},
  ];
  const accessoires = [
    {id: 'chargeur', name: 'Chargeur', price: 15, stock: 10, img: 'https://i.imgur.com/QylodKV.jpeg'},
    {id: 'cable_hdmi', name: 'Câble HDMI', price: 5, stock: 25, img: 'https://i.imgur.com/CYJdCjc.jpeg'},
    {id: 'chargeur_joycon', name: 'Chargeur Joy-Con', price: 10, stock: 12, img: 'https://i.imgur.com/2a17uZp.jpeg'},
  ];

  // Variables pour stocker choix
  let choixSwitch = null;
  let choixSD = null;
  const choixJoycon = {}; // id => qty
  const choixAccessoire = new Set();

  // --- Fonction création carte ---
  function createOptionCard(item, container, singleSelect = true, onSelect = null) {
    const div = document.createElement('div');
    div.classList.add('option');
    div.dataset.id = item.id;

    const img = document.createElement('img');
    img.src = item.img;
    img.alt = item.name;
    div.appendChild(img);

    const nameDiv = document.createElement('div');
    nameDiv.textContent = item.name;
    div.appendChild(nameDiv);

    if (item.price !== undefined) {
      const priceDiv = document.createElement('div');
      priceDiv.style.fontWeight = 'normal';
      priceDiv.style.fontSize = '0.9rem';
      priceDiv.textContent = item.price === 0 ? '0€' : item.price + ' €';
      div.appendChild(priceDiv);
    }

    div.title = item.stock > 0 ? `Stock disponible: ${item.stock}` : 'Rupture de stock';

    if (item.stock <= 0) {
      div.style.opacity = 0.5;
      div.style.pointerEvents = 'none';
    }

    div.addEventListener('click', () => {
      if(singleSelect) {
        // Déco sélection précédente
        container.querySelectorAll('.option.selected').forEach(e => e.classList.remove('selected'));
        div.classList.add('selected');
        if(onSelect) onSelect(item.id);
      } else {
        // Pour accessoires: toggle sélection
        if(div.classList.contains('selected')) {
          div.classList.remove('selected');
          if(onSelect) onSelect(item.id, false);
        } else {
          div.classList.add('selected');
          if(onSelect) onSelect(item.id, true);
        }
      }
    });
    return div;
  }

  // --- Remplissage containers ---
  const switchContainer = document.getElementById('switchContainer');
  const sdContainer = document.getElementById('sdContainer');
  const joyconContainer = document.getElementById('joyconContainer');
  const accessoireContainer = document.getElementById('accessoireContainer');

  // Switch (single select + zoom)
  switches.forEach(sw => {
    const card = createOptionCard(sw, switchContainer, true, (id) => {
      choixSwitch = switches.find(s => s.id === id);
      updateResume();
    });
    const img = card.querySelector('img');
    card.addEventListener('click', () => {
      // toggle zoom on selected only
      if(card.classList.contains('selected')) {
        if(img.classList.contains('zoomed')) img.classList.remove('zoomed');
        else {
          // remove zoom on others
          switchContainer.querySelectorAll('img.zoomed').forEach(i => i.classList.remove('zoomed'));
          img.classList.add('zoomed');
        }
      }
    });
    switchContainer.appendChild(card);
  });

  // SD (single select)
  sds.forEach(sd => {
    const card = createOptionCard(sd, sdContainer, true, (id) => {
      choixSD = sds.find(s => s.id === id);
      updateResume();
    });
    sdContainer.appendChild(card);
  });

  // Joycon (multiple select avec qty)
  joycons.forEach(jc => {
    const div = document.createElement('div');
    div.classList.add('option');
    div.dataset.id = jc.id;

    const img = document.createElement('img');
    img.src = jc.img;
    img.alt = jc.name;
    div.appendChild(img);

    const nameDiv = document.createElement('div');
    nameDiv.textContent = jc.name;
    div.appendChild(nameDiv);

    const qtyControl = document.createElement('div');
    qtyControl.className = 'qty-control';

    const btnMinus = document.createElement('button');
    btnMinus.textContent = '-';
    btnMinus.disabled = true;

    const qtyDisplay = document.createElement('div');
    qtyDisplay.className = 'qty-display';
    qtyDisplay.textContent = '0';

    const btnPlus = document.createElement('button');
    btnPlus.textContent = '+';

    qtyControl.appendChild(btnMinus);
    qtyControl.appendChild(qtyDisplay);
    qtyControl.appendChild(btnPlus);
    div.appendChild(qtyControl);

    let qty = 0;

    function updateButtons() {
      btnMinus.disabled = qty === 0;
      btnPlus.disabled = qty >= jc.stock;
    }

    btnPlus.addEventListener('click', () => {
      if(qty < jc.stock){
        qty++;
        qtyDisplay.textContent = qty;
        updateButtons();
        choixJoycon[jc.id] = qty;
        updateResume();
      }
    });
    btnMinus.addEventListener('click', () => {
      if(qty > 0){
        qty--;
        qtyDisplay.textContent = qty;
        updateButtons();
        if(qty === 0) delete choixJoycon[jc.id];
        else choixJoycon[jc.id] = qty;
        updateResume();
      }
    });
    updateButtons();

    joyconContainer.appendChild(div);
  });

  // Accessoires (multiple select toggle)
  accessoires.forEach(acc => {
    const card = createOptionCard(acc, accessoireContainer, false, (id, selected) => {
      if(selected) choixAccessoire.add(id);
      else choixAccessoire.delete(id);
      updateResume();
    });
    accessoireContainer.appendChild(card);
  });

  // --- Génération résumé ticket ---
  function updateResume(){
    if(!choixSwitch) {
      document.getElementById('resumeCommande').textContent = "Veuillez choisir une Switch.";
      return;
    }
    let lines = [];
    lines.push("✅ Résumé de commande");
    lines.push(`Code : CMD-${Math.random().toString(36).substr(2, 7).toUpperCase()}`);
    lines.push("");

    // Switch
    lines.push(`${choixSwitch.name} x1`.padEnd(30) + `${choixSwitch.price} €`);
    // Option SD
    if(choixSD){
      lines.push(`  (${choixSD.name})`.padEnd(30) + `${choixSD.price} €`);
    } else {
      lines.push("  (Sans carte SD)".padEnd(30) + `0 €`);
    }
    // Joycons
    if(Object.keys(choixJoycon).length > 0){
      lines.push("");
      lines.push("Joycon:");
      for(let jcId in choixJoycon){
        const qty = choixJoycon[jcId];
        const jc = joycons.find(j => j.id === jcId);
        if(qty > 0){
          // Calcul prix dégressif
          let prixJC = qty === 1 ? jc.priceFirst : jc.priceFirst + (qty-1)*jc.priceNext;
          lines.push(`  ${jc.name} x${qty}`.padEnd(30) + `${prixJC} €`);
        }
      }
    }

    // Accessoires
    if(choixAccessoire.size > 0){
      lines.push("");
      lines.push("Accessoires:");
      choixAccessoire.forEach(id => {
        const acc = accessoires.find(a => a.id === id);
        if(acc) lines.push(`  ${acc.name}`.padEnd(30) + `${acc.price} €`);
      });
    }

    // Total
    let total = choixSwitch.price + (choixSD ? choixSD.price : 0);
    for(let jcId in choixJoycon){
      const qty = choixJoycon[jcId];
      const jc = joycons.find(j => j.id === jcId);
      if(qty > 0){
        total += qty === 1 ? jc.priceFirst : jc.priceFirst + (qty-1)*jc.priceNext;
      }
    }
    choixAccessoire.forEach(id => {
      const acc = accessoires.find(a => a.id === id);
      if(acc) total += acc.price;
    });

    lines.push("");
    lines.push("-".repeat(30));
    lines.push(`Total : ${total} €`);

    document.getElementById('resumeCommande').textContent = lines.join('\n');
  }

  updateResume();

  // --- Téléchargement résumé en image ---
  document.getElementById('btnValider').addEventListener('click', () => {
    const resume = document.getElementById('resumeCommande');
    html2canvas(resume).then(canvas => {
      canvas.toBlob(blob => {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'commande_switch.png';
        a.click();
        URL.revokeObjectURL(a.href);
      });
    });
  });
</script>

</body>
</html>
