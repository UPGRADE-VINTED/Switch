<!-- Étape 1 Switch avec images plus grandes -->
<div class="step" id="step1">
  <h2>1. Choisissez votre Switch</h2>
  <div id="switch-options">
    <div class="option" data-name="Switch OLED" data-price="350" style="cursor:pointer;">
      <img src="switch_oled.png" alt="Switch OLED" style="width:200px; height:auto; display:block; margin-bottom:8px;">
      Switch OLED - 350 €
    </div>
    <div class="option" data-name="Switch Lite" data-price="200" style="cursor:pointer;">
      <img src="switch_lite.png" alt="Switch Lite" style="width:200px; height:auto; display:block; margin-bottom:8px;">
      Switch Lite - 200 €
    </div>
  </div>
</div>

<!-- Étape 2 Carte SD -->
<div class="step" id="step2" style="display:none;">
  <h2>2. Choisissez votre Carte SD</h2>
  <div id="sd-options">
    <div class="option" data-name="Carte SD 64Go" data-price="30" style="cursor:pointer;">
      <img src="sd_64go.png" alt="SD 64Go" style="width:100px; height:auto; display:block; margin-bottom:8px;">
      Carte SD 64Go - 30 €
    </div>
    <div class="option" data-name="Carte SD 128Go" data-price="50" style="cursor:pointer;">
      <img src="sd_128go.png" alt="SD 128Go" style="width:100px; height:auto; display:block; margin-bottom:8px;">
      Carte SD 128Go - 50 €
    </div>
  </div>
</div>

<!-- Étape 3 Joy-Con -->
<div class="step" id="step3" style="display:none;">
  <h2>3. Choisissez vos Joy-Con</h2>
  <div id="joycon-options">
    <div class="option" data-name="Joy-Con Bleu" data-baseprice="35" data-addprice="30" data-stock="5" data-qty="0" style="margin-bottom:10px;">
      Joy-Con Bleu<br>
      <button class="qty-minus" disabled>-</button>
      <span class="qty">0</span>
      <button class="qty-plus">+</button>
      <span>Stock: <span class="stock-count">5</span></span>
      <span>Prix total: <span class="price">0.00</span> €</span>
    </div>
    <div class="option" data-name="Joy-Con Rouge" data-baseprice="35" data-addprice="30" data-stock="3" data-qty="0" style="margin-bottom:10px;">
      Joy-Con Rouge<br>
      <button class="qty-minus" disabled>-</button>
      <span class="qty">0</span>
      <button class="qty-plus">+</button>
      <span>Stock: <span class="stock-count">3</span></span>
      <span>Prix total: <span class="price">0.00</span> €</span>
    </div>
  </div>
</div>

<!-- Étape 3bis Accessoires -->
<div class="step" id="step3bis" style="display:none;">
  <h2>3bis. Choisissez vos Accessoires</h2>
  <div id="accessory-options">
    <div class="option" data-name="Étui de protection" data-price="20" style="cursor:pointer; margin-bottom:8px;">
      <input type="checkbox" id="acc1" />
      <label for="acc1">Étui de protection - 20 €</label>
    </div>
    <div class="option" data-name="Station de recharge" data-price="40" style="cursor:pointer; margin-bottom:8px;">
      <input type="checkbox" id="acc2" />
      <label for="acc2">Station de recharge - 40 €</label>
    </div>
    <div class="option" data-name="Carte cadeau 10€" data-price="10" style="cursor:pointer; margin-bottom:8px;">
      <input type="checkbox" id="acc3" />
      <label for="acc3">Carte cadeau 10€ - 10 €</label>
    </div>
  </div>
</div>

<!-- Étape 4 Récapitulatif -->
<div class="step" id="step4" style="display:none;">
  <h2>4. Récapitulatif</h2>
  <pre id="summary" style="white-space: pre-wrap; background:#f0f0f0; padding:10px; border-radius:5px; max-height:300px; overflow:auto;">Aucune sélection pour l'instant.</pre>
  <div style="margin-top:20px;">
    <button id="restartBtn" style="margin-right:15px;">Recommencer</button>
    <button id="validateBtn">Valider pack & générer image</button>
  </div>
  <canvas id="summaryCanvas" width="400" height="300" style="border:1px solid #ccc; margin-top:20px; display:none;"></canvas>
  <a id="downloadLink" style="display:none; margin-top:10px; display:block;">Télécharger l'image</a>
</div>

<script>
  const nextBtn = document.getElementById('nextBtn');
  let currentStep = 1;

  const steps = {
    1: document.getElementById('step1'),
    2: document.getElementById('step2'),
    3: document.getElementById('step3'),
    3.5: document.getElementById('step3bis'), // étape Accessoires
    4: document.getElementById('step4'),
  };

  // Variables pour stocker les choix
  let chosenSwitch = null;
  let chosenSD = null;
  let joyConSelections = []; // {name, qty, price}
  let accessorySelections = []; // {name, price}

  // Étape 1 Switch
  const switchOptions = document.getElementById('switch-options');
  switchOptions.querySelectorAll('.option').forEach(opt => {
    opt.addEventListener('click', () => {
      // Sélection exclusive
      switchOptions.querySelectorAll('.option').forEach(o => o.classList.remove('selected'));
      opt.classList.add('selected');
      chosenSwitch = {
        name: opt.dataset.name,
        price: parseFloat(opt.dataset.price)
      };
    });
  });

  // Étape 2 SD
  const sdOptions = document.getElementById('sd-options');
  sdOptions.querySelectorAll('.option').forEach(opt => {
    opt.addEventListener('click', () => {
      sdOptions.querySelectorAll('.option').forEach(o => o.classList.remove('selected'));
      opt.classList.add('selected');
      chosenSD = {
        name: opt.dataset.name,
        price: parseFloat(opt.dataset.price)
      };
    });
  });

  // Étape 3 Joy-Con
  const joyConOptions = document.getElementById('joycon-options');
  joyConOptions.querySelectorAll('.option').forEach(opt => {
    const plusBtn = opt.querySelector('.qty-plus');
    const minusBtn = opt.querySelector('.qty-minus');
    const qtySpan = opt.querySelector('.qty');
    const stock = parseInt(opt.dataset.stock);
    const basePrice = parseFloat(opt.dataset.baseprice);
    const addPrice = parseFloat(opt.dataset.addprice);
    let qty = 0;

    function updatePriceAndQtyDisplay() {
      qtySpan.textContent = qty;
      minusBtn.disabled = qty <= 0;
      plusBtn.disabled = qty >= stock;
      let totalPrice = qty > 0 ? basePrice + (qty - 1) * addPrice : 0;
      opt.querySelector('.price').textContent = totalPrice.toFixed(2);
      opt.dataset.qty = qty;
      updateJoyConSelections();
    }

    plusBtn.addEventListener('click', () => {
      if(qty < stock){
        qty++;
        updatePriceAndQtyDisplay();
      }
    });
    minusBtn.addEventListener('click', () => {
      if(qty > 0){
        qty--;
        updatePriceAndQtyDisplay();
      }
    });

    updatePriceAndQtyDisplay();
  });

  function updateJoyConSelections(){
    joyConSelections = [];
    joyConOptions.querySelectorAll('.option').forEach(opt => {
      const qty = parseInt(opt.dataset.qty);
      if(qty > 0){
        const basePrice = parseFloat(opt.dataset.baseprice);
        const addPrice = parseFloat(opt.dataset.addprice);
        const totalPrice = basePrice + (qty -1)*addPrice;
        joyConSelections.push({
          name: opt.dataset.name,
          qty: qty,
          price: totalPrice
        });
      }
    });
  }

  // Étape 3bis Accessoires
  const accessoryOptions = document.getElementById('accessory-options');
  accessoryOptions.querySelectorAll('input[type=checkbox]').forEach(chk => {
    chk.addEventListener('change', () => {
      updateAccessorySelections();
    });
  });

  function updateAccessorySelections(){
    accessorySelections = [];
    accessoryOptions.querySelectorAll('input[type=checkbox]').forEach(chk => {
      if(chk.checked){
        const parent = chk.parentNode;
        accessorySelections.push({
          name: parent.dataset.name || parent.textContent.trim(),
          price: parseFloat(parent.dataset.price) || parseFloat(chk.nextElementSibling.textContent.match(/\d+/)[0])
        });
      }
    });
  }

  // Résumé
  function updateSummary() {
    let text = '';
    let total = 0;

    if(chosenSwitch){
      text += `Switch sélectionnée : ${chosenSwitch.name} - ${chosenSwitch.price.toFixed(2)} €\n`;
      total += chosenSwitch.price;
    } else {
      text += "Switch sélectionnée : Aucune\n";
    }

    if(chosenSD){
      text += `Carte SD : ${chosenSD.name} - ${chosenSD.price.toFixed(2)} €\n`;
      total += chosenSD.price;
    } else {
      text += "Carte SD : Aucune\n";
    }

    if(joyConSelections.length > 0){
      text += `Joy-Con sélectionnés :\n`;
      joyConSelections.forEach(jc => {
        text += `  - ${jc.name} x${jc.qty} : ${jc.price.toFixed(2)} €\n`;
        total += jc.price;
      });
    } else {
      text += "Joy-Con sélectionnés : Aucun\n";
    }

    if(accessorySelections.length > 0){
      text += `Accessoires sélectionnés :\n`;
      accessorySelections.forEach(acc => {
        text += `  - ${acc.name} : ${acc.price.toFixed(2)} €\n`;
        total += acc.price;
      });
    } else {
      text += "Accessoires sélectionnés : Aucun\n";
    }

    text += `\nTotal à payer : ${total.toFixed(2)} €`;
    document.getElementById('summary').textContent = text;
  }

  // Navigation
  nextBtn.addEventListener('click', () => {
    if(currentStep === 1){
      if(!chosenSwitch){
        alert("Veuillez choisir une Switch.");
        return;
      }
      steps[1].style.display = "none";
      steps[2].style.display = "block";
      currentStep = 2;
    } else if(currentStep === 2){
      if(!chosenSD){
        alert("Veuillez choisir une carte SD.");
        return;
      }
      steps[2].style.display = "none";
      steps[3].style.display = "block";
      currentStep = 3;
    } else if(currentStep === 3){
      // Joy-Con facultatif
      steps[3].style.display = "none";
      steps[3.5].style.display = "block";
      currentStep = 3.5;
    } else if(currentStep === 3.5){
      updateAccessorySelections();
      steps[3.5].style.display = "none";
      updateSummary();
      steps[4].style.display = "block";
      nextBtn.style.display = "none";
      currentStep = 4;
    }
  });

  // Bouton Recommencer
  document.getElementById('restartBtn').addEventListener('click', () => {
    location.reload();
  });

  // Bouton Valider + génération image
  document.getElementById('validateBtn').addEventListener('click', () => {
    updateSummary();
    generateSummaryImage();
  });

  function generateSummaryImage(){
    const canvas = document.getElementById('summaryCanvas');
    const ctx = canvas.getContext('2d');
    canvas.style.display = 'block';
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // Fond clair
    ctx.fillStyle = '#fff';
    ctx.fillRect(0,0,canvas.width,canvas.height);

    // Texte résumé
    const text = document.getElementById('summary').textContent;
    ctx.fillStyle = '#000';
    ctx.font = '16px Arial';
    const lineHeight = 20;
    const lines = text.split('\n');

    let y = 30;
    ctx.fillText('Résumé de votre pack :', 10, y);
    y += lineHeight + 5;

    lines.forEach(line => {
      ctx.fillText(line, 10, y);
      y += lineHeight;
    });

    // Préparer lien de téléchargement
    const dataURL = canvas.toDataURL('image/png');
    const downloadLink = document.getElementById('downloadLink');
    downloadLink.href = dataURL;
    downloadLink.download = 'pack-switch.png';
    downloadLink.textContent = 'Télécharger l\'image du pack';
    downloadLink.style.display = 'block';
  }

</script>
