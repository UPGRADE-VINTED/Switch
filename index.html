// Stock Joy-Con, images etc. restent identiques...

function updateConfig() {
  const imageDiv = document.getElementById('images');
  imageDiv.innerHTML = '';
  let total = 0;

  // Switch choisi
  const switchOption = document.getElementById('switchSelect').value.split('|');
  const switchName = switchOption[0];
  const switchPrice = parseInt(switchOption[1]);
  const switchImgKey = switchOption[2];
  if (!isNaN(switchPrice)) total += switchPrice;
  addImage(switchImgKey);

  // Joycons : 1Ã¨re paire 35â‚¬, suivantes 30â‚¬
  let index = 0;
  let joyconSummary = '';
  for(const key in stockJoycon) {
    const qty = parseInt(document.getElementById(`${key}_qty`).innerText);
    if(qty > 0){
      for(let i=0; i<qty; i++) {
        total += (index === 0) ? 35 : 30;
        addImage(key);
        index++;
      }
      joyconSummary += `- Joy-Con ${formatJoyconName(key)} x${qty} : ${qty === 1 ? (index === 1 ? '35â‚¬' : '30â‚¬') : (35 + (qty-1)*30)}â‚¬\n`;
    }
  }

  // Carte SD
  const sd = document.getElementById('sdSelect').value.split('|');
  const sdName = sd[0];
  const sdPrice = parseInt(sd[1]);
  const sdImgKey = sd[2];
  if (!isNaN(sdPrice)) total += sdPrice;
  addImage(sdImgKey);

  // Accessoires cochÃ©s
  let accessoiresSummary = '';
  document.querySelectorAll('input[type=checkbox]:checked').forEach(el => {
    const val = parseInt(el.value);
    if (!isNaN(val)) {
      total += val;
      addImage(el.getAttribute('data-img'));
      accessoiresSummary += `- ${el.parentElement.textContent.trim()} : ${val}â‚¬\n`;
    }
  });

  document.getElementById('total').innerText = 'Total : ' + total + 'â‚¬';

  // Mise Ã  jour du rÃ©sumÃ© de commande texte
  const summary = `
âœ… RÃ©sumÃ© de commande
Code : ${currentCode || '---'}

Console : ${switchName} â€” ${switchPrice}â‚¬
Carte SD : ${sdName} â€” ${sdPrice}â‚¬
${joyconSummary}${accessoiresSummary}
Total Ã  payer : ${total}â‚¬
  `.trim();

  document.getElementById('summary').innerText = summary;

  function addImage(key) {
    const img = document.createElement('img');
    img.src = images[key];
    imageDiv.appendChild(img);
  }
}

// Format friendly pour JoyCon
function formatJoyconName(key){
  switch(key){
    case 'joycon_rouge_bleu': return 'rouge/bleu';
    case 'joycon_vert_rose': return 'vert/rose';
    case 'joycon_gris': return 'gris';
    case 'joycon_jaune': return 'Ã©dition Zelda';
    case 'joycon_violet': return 'jaune/violet';
    default: return key;
  }
}

let currentCode = null;

function validerCommande() {
  // GÃ©nÃ©rer un code unique et garder en variable globale pour le rÃ©sumÃ©
  currentCode = 'CMD-' + Math.random().toString(36).substring(2,8).toUpperCase();

  const summaryDiv = document.getElementById('summary');

  // Utiliser html2canvas pour capturer la div summary (texte rÃ©sumÃ©)
  html2canvas(summaryDiv).then(canvas => {
    const imageURL = canvas.toDataURL();

    // Afficher dans summary une version enrichie avec image et lien tÃ©lÃ©chargement
    summaryDiv.innerHTML = `
      <h2>âœ… RÃ©sumÃ© de commande</h2>
      <p>Code de commande : <strong>${currentCode}</strong></p>
      <pre style="white-space: pre-wrap; font-family: monospace; font-size: 1rem; line-height: 1.3;">${summaryDiv.innerText}</pre>
      <img src="${imageURL}" style="width:300px; border:1px solid #ccc; margin-top: 10px;" />
      <a href="${imageURL}" download="commande-${currentCode}.png">ğŸ“¥ TÃ©lÃ©charger l'image</a>
    `;
  });
}

// Initialisation
document.addEventListener('DOMContentLoaded', () => {
  updateConfig();
});
